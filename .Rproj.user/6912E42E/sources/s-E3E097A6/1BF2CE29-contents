# This script will house the post-processing options and functionality
# Last edited by Elaina Passero on 01/24/20

# Load required packages
packages <- c("SDMTools","sp","raster","rgeos","rgdal","sf","spatstat","spdep","tidyverse","rasterVis",
              "ggplot2","data.table","dplyr","spex","stars","igraph","deldir","hydroTSM",
              "lubridate","rlist")
#  Check to see if each is installed, and install if not.
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {    
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
# load the installed libraries in the packages list 
lapply(packages,library,character.only=TRUE)
###########################################

# User inputs
post_tag <- "test" # unique code to identify current run of DSS
fish_tag <- "test" # code of fish results to pull results for

wd <- "C:/Users/epassero/Desktop/VRDSS/verde-refdss/" # Project working directory
#wd <- "/Users/Morrison/Documents/Active Research Projects/Verde REFDSS/verde-refdss/" # Set path to local repository
setwd(wd)

hab_mets <- list("Depth","Velocity") #Variables from iRIC calculation result used for habitat analysis - case sensitive
#species_list <- c("longfindace","desertsucker") #"sonoransucker") #"yellowbullhead", "sonoransucker","redshiner","roundtailchub","greensunfish","fatheadminnow","speckleddace")
species_list <- c("desertsucker","smallmouthbass") # fish species list
lifestages <- list("adult") #lifestages from oldest to youngest; must match order in HSC table
veg_list <- c("drgt_tol_shrubs","tall_trees") # vegetation group list
reach_name <- "USBeasley1" # Should match name of folder with results
dis_unit <- "cms" #units of discharge

# Yes or No. Indicate whether or not to substrate was a condition of suitable habitat
CheckSub <- "Yes"

# Yes or No. Choose whether or not to normalize habitat area by reach length
NormalizeByL <- "Yes"; if(NormalizeByL=="Yes"){
  reach_length <- 0.5
  length_unit <- "km"}

# Yes or No. Choose whether or not to calculate X-day statistics. Must supply number of days.
CalcXDayStats <- "No"; if(CalcXDayStats=="Yes"){
  x_days <- 7} # number of days for moving area statistics

# Yes or No. Yes - limit analysis to supplied dates. No - consider entire hydrograph.
DateRange <- "No"; if(DateRange=="Yes"){
  start_date <- "1974-01-01" # "YYYY-MM-DD"
  end_date <- "1994-12-31"} # "YYYY-MM-DD"

# Yes or No. Yes - bring in flow scenarios to compare to baseline conditions
LoadScenario <- "Yes"; if(LoadScenario == "Yes"){
  scene_names <- c("red_25_percent")
}

### End of User Inputs ###

### Begin post-processing ###

reach_wd <- paste(wd,"reaches","/",reach_name,"/",sep = "")
output_name <- load(file=paste(reach_wd,reach_name,"_",fish_tag,"_fish_outputs.rdata",sep="")) # load fish outputs
eval(parse(text=paste("fish_outputs=",output_name)))

## Read in historic flow record (baseline)
baseline_q <- na.omit(fread(paste(reach_wd,"flow_scenarios","/",reach_name,"_baseline_q",".csv",sep=""),
                            header=TRUE, sep = ",",data.table=FALSE))
baseline_q$date <- as.Date(baseline_q$date)
if(DateRange=="Yes"){
  baseline_q <- subset(baseline_q, date > as.Date(start_date)) 
  baseline_q <- subset(baseline_q, date < as.Date(end_date))
}

# # to convert from CFS to CMS
# baseline_q <- baseline_q %>%
#   mutate(discharge.cms = discharge*0.02832) %>%
#   select(-discharge) %>%
#   rename(discharge = discharge.cms)

# create list of flow scenario data frames

if(LoadScenario == "Yes"){
  scene_list <- lapply(scene_names, function(s){
    q_ts <- na.omit(fread(file=paste(reach_wd,"flow_scenarios","/",reach_name,"_",s,".csv",sep=""),
                          header=TRUE, sep = ",",data.table=FALSE)) %>%
      mutate(date_form = as.Date(date)) %>%
      select(-date) %>%
      rename(date = date_form)
    if(DateRange=="Yes"){
      q_ts <- subset(q_ts, date > as.Date(start_date)) 
      q_ts <- subset(q_ts, date < as.Date(end_date))
    }
    return(q_ts)
  })
  names(scene_list) <- scene_names
  scene_list$baseline_q <- baseline_q
  scene_names <- names(scene_list) # updated scene name list for labeling
} else{
  scene_list <- list(baseline_q)
  scene_names <- "baseline_q"
  names(scene_list) <- scene_names
}



# Fish post-processing
scene_fish_out <- list()
scene_fish_out <- lapply(scene_names, function(scene_name){
  
  s <- scene_list[[scene_name]]
  
  post_fish_outputs <- list()
  post_fish_outputs <- lapply(species_list, function(species){ 
    one_spec <- fish_outputs[[species]]
    for(i in 1:length(one_spec)){ # extracts the outputs by species into their own object
      tempobj = one_spec[[i]]
      eval(parse(text=paste(names(one_spec)[[i]],"=tempobj")))
    }
    
    # Flow-Scenario related scripts
    source("interp.table.R")
    inter_tab <- lapply(lifestages, function(a) interp.table(a,s,area_look_tab,NormalizeByL))
    names(inter_tab) <- lifestages
    post_fish_outputs$inter_tab <- inter_tab
    
    # Generate and view plots of total area through the hydrograph
    source("interp.plot.R")
    inter_plots <- interp.plot(inter_tab,NormalizeByL,species,scene_name)
    names(inter_plots) <- species
    post_fish_outputs$inter_plots <- inter_plots
    
    ## Generate Data Frames of moving X-Day area and discharge statistics
    if(CalcXDayStats=="Yes"){
      source("x.day.stats.R")
      x_day_stats <- lapply(lifestages, function(a) x.day.stats(a,inter_tab,x_days,NormalizeByL,reach_length))
      names(x_day_stats) <- lifestages
      post_fish_outputs$x_day_stats <- x_day_stats
    }
    
    source("avg.month.area.R")
    avg_monthly_area <- lapply(lifestages, function(a) avg.month.area(a,inter_tab,NormalizeByL))
    names(avg_monthly_area) <- lifestages
    post_fish_outputs$avg_monthly_area <- avg_monthly_area
    # end of flow scenario dependent processes
    
    return(post_fish_outputs)
  }) # end of single species function
  
  names(post_fish_outputs) <- species_list
  
  return(post_fish_outputs)
}) # end of flow scenario list function
names(scene_fish_out) <- names(scene_list)

# save outputs (dss_outputs) for internal use
for(s in 1:length(scene_fish_out)){
  scene <- names(scene_fish_out)[[s]]
  list.save(scene_fish_out[[s]],file=paste(reach_wd,"dss_outputs/",reach_name,"_",scene,"_post_fish.rdata",sep=""))
}

# Figures and tables for export
post_fish_figs <- list()
post_fish_figs <- lapply(species_list, function(species){
  
  source("plot.10day.ts.R")
  ten_day_ts_plt <- lapply(lifestages, function(a) plot.10day.ts(a,species,scene_fish_out,scene_list,NormalizeByL,post_tag))
  names(ten_day_ts_plt) <- lifestages
  post_fish_figs$ten_day_ts_plt <- ten_day_ts_plt 
  
  source("build.10day.tables.R") # currently set up for adults only
  ten_day_min_outputs <- lapply(lifestages, function(a) build.10day.tables(a,species,scene_list,scene_fish_out,post_tag))
  names(ten_day_min_outputs) <- lifestages
  post_fish_figs$ten_day_min_outputs <- ten_day_min_outputs
  
  source("make.barplots.chg.R")
  chg_barplots <- lapply(lifestages, function(a) make.barplots.chg(a,species,ten_day_min_outputs))
  names(chg_barplots) <- lifestages
  post_fish_figs$chg_barplots <- chg_barplots
  
  return(post_fish_figs)
})
names(post_fish_figs) <- species_list



# Producing Figures for Chris + Dave

# source("calc.hab.retention.R")
# hab_retention <- lapply(scene_fish_out, habitat.retention())

# source("interp.plot.abbr.R")
# scenario <- "baseline"
# 
# # annual
# inter_plots_ann <- lapply(species_list, function(species) {
#   inter_tab <- scene_fish_out[[scenario]][[species]]$inter_tab
#   write.csv(inter_tab,file = paste(scenario,"_",species,"_tab.csv",sep=""))
#   interp.plot.abbr(inter_tab,NormalizeByL,as.Date("1990-01-01"),as.Date("1990-12-31"),scenario,species)
#   ggsave(paste(scenario,"_",species,"_","annual.png",sep=""),width=7, height=5,units = "in")
#   })
# names(inter_plots_ann) <- species_list
# inter_plots_ann
# 
# # monthly
# inter_plots_mon <- lapply(species_list, function(species) {
#   inter_tab <- scene_fish_out[[scenario]][[species]]$inter_tab
#   interp.plot.abbr(inter_tab,NormalizeByL,as.Date("1990-07-01"),as.Date("1990-08-31"),scenario,species)
#   ggsave(paste(scenario,"_",species,"_","monthly.png",sep=""),width=7, height=5,units = "in")
# })
# names(inter_plots_mon) <- species_list
# inter_plots_mon


# Riparian vegetation post-processing
output_name <- load(file=paste(reach_wd,reach_name,"_pre_outputs.rdata",sep="")) # load rasterized 2D modeling results
eval(parse(text=paste("pre_outputs=",output_name)))

out_val_rast <- pre_outputs$out_val_rast
modeled_q <- pre_outputs$modeled_q


scene_veg_out <- list()
scene_veg_out <- lapply(scene_names, function(scene_name){
  
  s <- scene_list[[scene_name]]
  
  source("q.ep.weibull.R")
  hydro_ep <- q.ep.weibull(s,modeled_q,scene_name)
  scene_veg_out$hydro_ep <- hydro_ep
  
   source("make.inun.q.map.R")
   wet_map <- make.inun.q.map(hydro_ep,out_val_rast,modeled_q,scene_name)
   scene_veg_out$wet_map <- wet_map
  
  source("make.ep.maps.R")
  ep_map <- make.ep.maps(hydro_ep,out_val_rast,modeled_q,scene_name)
  scene_veg_out$ep_map <- ep_map
  
  # make maps of probability of occurrence of vegetation
  all_veg_logit <- fread(paste(reach_wd,"habitat_info","/",reach_name,"_veg_pref",".csv",sep=""),
                        header=TRUE, sep = ",",data.table = FALSE) # load logistic equations
  
  source("find.veg.logit.R"); source("find.prob.occur.R"); source("make.veg.maps.R")
  prob_veg_maps <- lapply(veg_list, function(v) {
    one_veg_logit <- find.veg.logit(all_veg_logit,v)
    hydro_ep_prob <- find.prob.occur(v,hydro_ep,one_veg_logit) # outputs table of discharge, EP of discharge, and Prob of Veg for discharge
    prob_veg_maps <- make.veg.maps(v,ep_map,hydro_ep_prob,scene_name)
    return(prob_veg_maps)
  })
  names(prob_veg_maps) <- veg_list
  scene_veg_out$prob_veg_maps <- prob_veg_maps
  return(scene_veg_out)
}) # end of flow scenario list function
names(scene_veg_out) <- names(scene_list)



