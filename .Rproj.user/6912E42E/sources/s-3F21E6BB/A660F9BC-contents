# This script is used to get suitable habitat that meets substrate type requirements.
# Last edited by Elaina Passero on 3/4/20

### Begin Function ###
by.substrate <- function(a, good_hab_list, sub_all_ages,rast_sub_map,fish){
  pos <- grep(a,names(sub_all_ages),ignore.case = TRUE)
  sub_req <- sub_all_ages[,pos] # substrate requirement for current lifestage
  sub_req <- as.numeric(sub_req[!is.na(sub_req)]) # remove any NA values
  
  sub_seq <- seq(min(sub_req),max(sub_req)+1,by=1)
  sub_rc <- data.frame(from=c(-Inf,sub_seq),to=c(sub_seq,Inf))
  sub_rc$become <- ifelse(sub_rc$from %in% sub_req,1,0)
  rcl <- as.matrix.data.frame(sub_rc,ncol=3)
  
  good_rast <- good_hab_list[[a]] # raster of suitable habitat for current lifestage
  
  rc_sub_map <- reclassify(rast_sub_map,rcl,right=FALSE) # reclassify substrate map based on substrate criteria
  writeRaster(rc_sub_map,filename = paste(reach_wd,"dss_outputs/",fish,"_",a,"_sub.tif",sep=""),format="GTiff")
  
  
  # Mask
  by_sub_brick <- mask(good_rast,rc_sub_map,inverse=TRUE,maskvalue=1,updatevalue=NA) # if cells not covered by acceptable substrate or are NA, they are set to NA
  return(by_sub_brick)
}


